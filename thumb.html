<html>
<head>
<script>
// TODO:
//  - Playlist thumbnails (2x2, so need 4 copy buttons).
//  - Hide clamping and the following options in an advanced section.
//  - Configurable dither direction.
//  - Configurable clamping limits.
//  - Tweakable colors (by default, just fix the white issue).

let domImage = null;
let domSize = null;
let domWide = null;
let domClamp = null;
let domInvis = null;
let domDither = null;
let domInputView = null;
let domOutputView = null;
let domBufferView = null;
let ctxInput = null;
let ctxOutput = null;
let ctxBuffer = null;
let inputFile = null;
let outputNotes = null;

function onLoad() {
  domImage = document.getElementById("image");
  domSize = document.getElementById("size");
  domWide = document.getElementById("wide");
  domClamp = document.getElementById("clamp");
  domInvis = document.getElementById("invis");
  domDither = document.getElementById("dither");
  domInputView = document.getElementById("input_view");
  domOutputView = document.getElementById("output_view");
  ctxInput = domInputView.getContext("2d");
  ctxOutput = domOutputView.getContext("2d");

  ctxOutput.imageSmoothingEnabled = false;

  domBufferView = document.createElement("canvas");
  ctxBuffer = domBufferView.getContext("2d");
}

function setInputFile(files) {
  for (const file of files) {
    if (file.type.startsWith('image/')) {
      inputFile = file;
      break;
    }
  }
  onChange();
}

function onFile() { setInputFile(domImage.files); }
function onDragOver(e) { e.preventDefault(); }
function onDrop(e) {
  e.preventDefault();
  setInputFileFromDataTransfer(e.dataTransfer);
}
function onPaste(e) {
  e.preventDefault();
  setInputFileFromDataTransfer(e.clipboardData);
}
function setInputFileFromDataTransfer(dt) {
  let files = [];
  if (dt.items) {
    for (const item of dt.items) {
      if (item.kind == "file") files.push(item.getAsFile());
    }
  } else {
    files = dt.files;
  }
  setInputFile(files);
}

function copyNotes() {
  if (outputNotes != null) navigator.clipboard.writeText(outputNotes);
}

const kNote = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

function onChange() {
  if (inputFile == null) return;
  const wide = domWide.checked;
  const noteLen = domInvis.checked ? " 0.000001 " : wide ? " 1 " : " 2 ";
  const small = domSize.value == "small";
  const base = small ? 3 * 12 + 5 /*F3*/ : 2 * 12 + 8 /*G#2*/;
  const height = small ? 32 : 50;
  const width = wide ? 2 * height + 1 : height;
  const clamp = domClamp.checked;
  const dither = parseFloat(domDither.value);

  domBufferView.width = width;
  domBufferView.height = height;

  const url = URL.createObjectURL(inputFile);
  const image = new Image();
  image.onload = function() {
    ctxInput.drawImage(image, 0, 0, domInputView.width, domInputView.height);
    ctxBuffer.drawImage(image, 0, 0, width, height);
    const notes = [];
    const out = run(ctxBuffer.getImageData(0, 0, width, height), clamp, dither,
                    function(i, j, k) {
      const n = height - 1 - j + base;
      const s = kNote[n % 12] + Math.floor(n / 12);
      notes.push((wide ? i : 2 * i) + " " + s + noteLen + k + " 0");
    });
    ctxBuffer.putImageData(out, 0, 0);
    ctxOutput.drawImage(
        domBufferView, 0, 0, domOutputView.width, domOutputView.height);
    URL.revokeObjectURL(url);
    outputNotes = "Online Sequencer:0:" + notes.join(";") + ";:";
  };
  image.src = url;
}

function fclamp(x) { return x <= 0 ? 0 : x >= 1 ? 1 : x; }

class Color {
  constructor(r, g, b, a) {
    this.r = r;
    this.g = g;
    this.b = b;
  }

  diff(c) {
    return new Color(this.r - c.r, this.g - c.g, this.b - c.b);
  }

  dist2(c) {
    const e = this.diff(c);
    return e.r * e.r + e.g * e.g + e.b * e.b;
  }

  mulAdd(c, k) {
    return new Color(this.r + k * c.r, this.g + k * c.g, this.b + k * c.b);
  }

  clamp() {
    return new Color(fclamp(this.r), fclamp(this.g), fclamp(this.b));
  }
}

function hexColor(red, green, blue) {
  return new Color(red / 0xFF, green / 0xFF, blue / 0xFF);
}

function pixIndex(w, h, i, j) { return j * w + i; }
function ditherPixel(a, w, h, i, j, e, x, clamp) {
  if (i >= 0 && i < w && j >= 0 && j < h) {
    const k = pixIndex(w, h, i, j);
    const c = a[k].mulAdd(e, x);
    a[k] = clamp ? c.clamp() : c;
  }
}

const kColors = [
  hexColor(0x03, 0xA9, 0xF4),
  hexColor(0xFF, 0x98, 0x00),
  hexColor(0xB7, 0x1C, 0x1C),
  hexColor(0xE9, 0x1E, 0x63),
  hexColor(0x4C, 0xAF, 0x50),
  hexColor(0x21, 0x21, 0x21),
  hexColor(0x3F, 0x51, 0xB5),
  hexColor(0xCD, 0xDC, 0x39),
  hexColor(0x15, 0x65, 0xC0),
  hexColor(0x82, 0x77, 0x17),
  hexColor(0xFF, 0xEA, 0x00),
  hexColor(0x8D, 0x6E, 0x63),
  hexColor(0x4E, 0x34, 0x2E),
  hexColor(0xFF, 0x63, 0x63),
  hexColor(0x75, 0xFF, 0x63),
  hexColor(0x63, 0xE0, 0xFF),
  hexColor(0xFD, 0x63, 0xFF),
  hexColor(0xFF, 0x57, 0x22),
  hexColor(0x1B, 0x5E, 0x20),
  hexColor(0xF4, 0x43, 0x36),
  hexColor(0xFF, 0xE0, 0xB2),
  hexColor(0x75, 0x75, 0x75),
  hexColor(0xE0, 0xAD, 0x00),
  hexColor(0xE9, 0xF9, 0xBD),
  hexColor(0xA8, 0xC8, 0x53),
  hexColor(0x0D, 0x47, 0xA1),
  hexColor(0x1D, 0x9D, 0x9D),
  hexColor(0x1E, 0xC5, 0x7A),
  hexColor(0x15, 0x21, 0x4F),
  hexColor(0x05, 0x10, 0x2F),
  hexColor(0x6C, 0xF3, 0xB7),
  hexColor(0xFF, 0x70, 0x70),
  hexColor(0xA1, 0xA6, 0x35),
  hexColor(0xEA, 0x79, 0x00),
  hexColor(0x55, 0xCA, 0xCA),
  hexColor(0x00, 0x80, 0x40),
  hexColor(0x7F, 0x0F, 0x48),
  hexColor(0x00, 0x00, 0x00),
  hexColor(0x00, 0x45, 0x1F),
  hexColor(0x9F, 0x0F, 0x22),
  hexColor(0x82, 0x05, 0x15),
  hexColor(0x03, 0xA9, 0xF4),
  hexColor(0x98, 0x00, 0xFE),
];

function run(img, clamp, dither, addNote) {
  const w = img.width;
  const h = img.height;
  let a = [];
  for (let i = 0; i < img.data.length; i += 4) {
    a.push(hexColor(img.data[i], img.data[i + 1], img.data[i + 2]));
  }
  let b = [];
  for (let j = 0; j < h; ++j) {
    for (let i = 0; i < w; ++i) {
      let c = a[pixIndex(w, h, i, j)];
      let mk = 0;
      let md2 = 0;
      for (let k = 0; k < kColors.length; ++k) {
        let d2 = c.dist2(kColors[k]);
        if (k == 0 || d2 < md2) {
          mk = k;
          md2 = d2;
        }
      }
      let mc = kColors[mk];
      b.push(mc);
      let e = c.diff(mc);
      ditherPixel(a, w, h, i + 1, j, e, dither * 7 / 16.0, clamp)
      ditherPixel(a, w, h, i - 1, j + 1, e, dither * 3 / 16.0, clamp)
      ditherPixel(a, w, h, i, j + 1, e, dither * 5 / 16.0, clamp)
      ditherPixel(a, w, h, i + 1, j + 1, e, dither * 1 / 16.0, clamp)
      addNote(i, j, mk);
    }
  }
  outData = new Uint8ClampedArray(4 * b.length);
  for (let i = 0; i < b.length; ++i) {
    outData[4 * i + 0] = 0xFF * b[i].r;
    outData[4 * i + 1] = 0xFF * b[i].g;
    outData[4 * i + 2] = 0xFF * b[i].b;
    outData[4 * i + 3] = 0xFF;
  }
  return new ImageData(outData, w, h);
}

const kBody = new Uint8Array([
    67,  77,  53,  16,  122, 109, 235, 80,  161, 109, 26,  46,  148, 192, 234,
    15,  21,  136, 51,  182, 46,  133, 229, 205, 30,  44,  113, 228, 17,  245,
    234, 51,  183, 195, 78,  150, 181, 76,  165, 55,  152, 22,  53,  44,  142,
    244, 12,  194, 186, 64,  89,  139, 16,  179, 244, 5,   215, 247, 109, 135,
    236, 111, 211, 95,  212, 5,   240, 235, 250, 46,  180, 43,  135, 194, 129,
    9,   129, 100, 43,  67,  143, 224, 66,  195, 142, 221, 37,  91,  79,  133,
    243, 81,  242, 192, 1,   248, 129, 213, 177, 110, 131, 71,  59,  234, 37,
    66,  129, 5,   200, 11,  206, 44,  91,  18,  45,  225, 245, 91,  137, 101,
    27,  189, 63,  238, 28,  189, 19,  93,  113, 62,  115, 211, 234, 201, 113,
    94,  183, 0,   199, 191, 170, 237, 60,  252, 152, 190, 3,   139, 188, 175,
    67,  82,  32,  87,  33,  137, 226, 216, 146, 188, 176, 88,  255, 173, 132,
    76,  137, 143, 172, 182, 45,  97,  196, 73,  178, 75,  106, 174, 118, 159,
    10,  204, 111, 34,  162, 37,  92,  208, 51,  94,  36,  156, 210, 207, 172,
    78,  46,  235, 203, 48,  110, 134, 120, 241, 10,  104, 138, 128, 112, 81,
    78,  134, 18,  71,  100, 181, 249, 2,   214, 238, 250, 94,  73,  44,  120,
    188, 109, 143, 163, 214, 47,  40,  161, 159, 20,  199, 163, 89,  140, 153,
    37,  210, 44,  66,  141, 183, 74,  47,  227, 11,  7,   154, 49,  15,  77,
    145, 13,  7,   192, 151, 203, 175, 43,  211, 78,  126, 254, 36,  124, 211,
    213, 109, 223, 102, 54,  1,   199, 111, 164, 16,  67,  69,  213, 84,  68,
    179, 10,  77,  112, 223, 122, 225, 11,  148, 124, 136, 74,  106, 246, 168,
    223, 173, 166, 162, 163, 201, 100, 254, 87,  159, 175, 190, 69,  77,  141,
    199, 106, 95,  187, 66,  193, 72,  159, 21,  51,  147, 28,  143, 41,  219,
    145, 249, 13,  247, 33,  148, 190, 67,  122, 36,  220, 36,  21,  53,  124,
    142, 77,  6,   223, 172, 252, 127, 105, 154, 29,  55,  200, 52,  190, 186,
    235, 238, 112, 34,  235, 83,  6,   167, 217, 122, 95,  154, 113, 45,  206,
    240, 35,  126, 66,  55,  130, 199, 223, 129, 67,  70,  176, 32,  8,   224,
    9,   5,   145, 82,  23,  96,  24,  63,  232, 2,   50,  5,   180, 211, 104,
    65,  203, 101, 226, 99,  40,  205, 65,  194, 132, 50,  166, 130, 121, 184,
    83,  252, 114, 225, 207, 234, 138, 169, 16,  97,  145, 91,  249, 224, 22,
    226, 23,  247, 233, 216, 226, 198, 74,  69,  51,  4,   199, 9,   44,  215,
    120, 224, 194, 88,  91,  24,  59,  3,   41,  101, 210, 123, 58,  23,  187,
    46,  66,  107, 198, 121, 78,  57,  14,  29,  70,  5,   181, 226, 5,   126,
    200, 230, 92,  240, 250, 135, 40,  50,  78,  57,  240, 4,   75,  152, 112,
    208, 133, 5,   218, 119, 30,  136, 58,  117, 150, 61,  67,  18,  11,  232,
    196, 11,  97,  11,  20,  127, 109, 10,  198, 65,  210, 215, 173, 31,  115,
    23,  171, 226, 38,  185, 138, 3,   118, 21,  156, 215, 252, 184, 53,  81,
    48,  97,  31,  1,   108, 104, 78,  17,  91,  146, 140, 234, 121, 158, 201,
    36,  145, 250, 29,  10,  171, 12,  172, 105, 77,  49,  238, 118, 247, 221,
    163, 245, 5,   101, 176, 125, 164, 137, 64,  145, 102, 224, 20,  22,  42,
    30,  50,  105, 254, 109, 249, 167, 185, 49,  178, 178, 247, 169, 61,  198,
    6,   171, 37,  0,   80,  38,  77,  46,  206, 166, 194, 94,  166, 126, 66,
    199, 210, 227, 215, 133, 243, 84,  69,  42,  132, 25,  231, 211, 213, 125,
    64,  171, 79,  208, 230, 20,  63,  61,  50,  202, 227, 247, 176, 142, 74,
    30,  218, 12,  37,  125, 145, 80,  45,  217, 190, 8,   41,  152, 249, 201,
    197, 152, 52,  56,  55,  37,  222, 77,  203, 235, 97,  246, 31,  72,  142,
    136, 183, 71,  31,  41,  238, 78,  161, 41,  141, 216, 193, 246, 31,  96,
    130, 233, 43,  233, 153, 75,  194, 184, 178, 11,  123, 5,   21,  25,  157,
    61,  252, 103, 214, 2,   67,  11,  151, 11,  89,  150, 253, 192, 209, 63,
    22,  55,  52,  139, 207, 162, 106, 51,  63,  223, 152, 50,  59,  208, 61,
    164, 221, 221, 93,  209, 135, 22,  246, 5,   145, 68,  39,  197, 147, 240,
    192, 77,  167, 37,  247, 19,  9,   190, 103, 84,  164, 152, 78,  52,  29,
    35,  137, 54,  194, 34,  24,  196, 30,  31,  243, 177, 188, 169, 30,  21,
    236, 239, 155, 228, 37,  155, 35,  14,  148, 186, 150, 133, 216, 31,  68,
    138, 82,  61,  120, 143, 81,  225, 84,  183, 195, 231, 50,  47,  118, 144,
    193, 253, 250, 129, 77,  121, 65,  10,  108, 157, 46,  44,  188, 36,  220,
    234, 154, 204, 12,  210, 69,  117, 83,  93,  177, 239, 233, 197, 249, 89,
    191, 142, 76,  46,  52,  209, 148, 187, 104, 49,  82,  204, 77,  40,  224,
    252, 73,  172, 232, 24,  148, 153, 13,  232, 188, 198, 215, 62,  93,  182,
    241, 214, 113, 112, 241, 57,  175, 100, 124, 243, 124, 202, 247, 41,  84,
    171, 63,  213, 186, 41,  105, 49,  123, 23,  197, 58,  61,  124, 1,   85,
    197, 133, 75,  216, 40,  204, 240, 13,  39,  185, 230, 208, 157, 18,  145,
    225, 224, 124, 237, 49,  20,  64,  73,  147, 20,  6,   87,  153, 48,  48,
    10,  33,  80,  193, 230, 228, 184, 6,   247, 57,  146, 156, 228, 205, 1,
    177, 175, 232, 203, 186, 122, 222, 167, 206, 199, 62,  60,  115, 238, 157,
    92,  242, 23,  129, 90,  33,  196, 79,  119, 29,  11,  86,  241, 166, 21,
    95,  191, 42,  243, 116, 97,  9,   218, 156, 102, 46,  98,  91,  105, 172,
    207, 82,  89,  50,  164, 227, 11,  29,  249, 243, 225, 46,  231, 115, 58,
    74,  127, 96,  133, 23,  102, 114, 44,  59,  107, 248, 126, 126, 41,  73,
    217, 17,  231, 2,   212, 161, 72,  75,  75,  177, 94,  227, 221, 218, 73,
    157, 180, 47,  55,  222, 107, 148, 98,  149, 24,  127, 80,  249, 50,  95,
    103, 83,  254, 81,  127, 83,  155, 77,  222, 97,  79,  113, 177, 38,  30,
    94,  4,   56,  51,  15,  96,  245, 183, 241, 52,  105, 16,  180, 128, 172,
    129, 142, 93,  48,  254, 92,  239, 16,  250, 117, 19,  212, 206, 47,  75,
    35,  233, 132, 133, 253, 234, 1,   109, 157, 55,  155, 47,  16,  156, 128,
    145, 240, 52,  204, 197, 237, 158, 231, 223, 134, 67,  228, 198, 87,  125,
    103, 57,  125, 225, 101, 236, 147, 40,  201, 251, 90,  112, 188, 7,   230,
    168, 239
]);

function decrypt(b, s) {
  let c = new Uint8Array(b);
  for (let i = 0; i < b.length; ++i) {
    s = (s ^ (s << 13)) % 0x100000000;
    s = (s ^ (s >>> 17)) % 0x100000000;
    s = (s ^ (s << 5)) % 0x100000000;
    c[i] = b[i] ^ (s % 0x100);
  }
  return (new TextDecoder()).decode(c);
}

function hash(str) {
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; ++i) {
    h ^= str.charCodeAt(i);
    h += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);
  }
  return h >>> 0;
}

function checkPassword(e) {
  let domPassword = document.getElementById("password");
  if (e.keyCode == 13 && hash(domPassword.value) == 0x6935ffe5) {
    document.getElementById("wrap").innerHTML = decrypt(
        kBody, hash(domPassword.value + "bababooey"));
    onLoad();
  }
}

</script>
<style>
body {
  background-color: #212121;
  margin: 0;
}
#head {
  background-color: #424242;
  width: 100%;
  display: flex;
  justify-content: space-around;
  margin-bottom: 16px;
}
h1, #index {
  color: #ffc107;
  text-align: center;
  font-family: monospace;
  font-size: 42px;
  flex-grow: 1;
  padding: 16px;
  margin: 0;
}
#index {
  color: #ff5722;
  text-decoration: none;
  flex-grow: 0;
}
a {
  color: #ff5722;
  font-family: monospace;
  font-size: 24px;
  cursor: pointer;
  text-decoration: underline;
}
#wrap { padding: 0 16px; }
#wrap, #image_label, button, select {
  color: #f5f5f5;
  font-family: monospace;
  font-size: 24px;
}
select {
  background-color: #424242;
}
input[type="file"] {
  display: none;
}
#views {
  display: flex;
  justify-content: space-evenly;
}
canvas {
  border: 1px solid #f5f5f5;
  width: 300px;
  height: 300px;
}
.view_label {
  width: 100%;
  text-align: center;
}
#password, #inner {
  width: 400px;
  margin: auto;
}
</style>
</head>
<body ondrop="onDrop(event)" ondragover="onDragOver(event)"
    onpaste="onPaste(event)">
<div id="head">
  <a id="index" href="index.html">&lt;</a>
  <h1>OS Thumbnail Generator</h1>
</div>
<div id="wrap">
  <div id="inner">
    Password
    <input type="text" id="password" onkeypress="checkPassword(event)"/>
  </div>
</div>
</body>
</html>
